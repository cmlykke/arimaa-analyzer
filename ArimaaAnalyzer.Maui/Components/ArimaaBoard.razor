@using ArimaaAnalyzer.Maui.Services.Arimaa
@inject ArimaaGameService Game

<div class="board">
    @for (var r = 0; r < 8; r++)
    {
        <div class="rank">
            @for (var c = 0; c < 8; c++)
            {
                var pos = new Position(r, c);
                var piece = Game.State.GetPiece(pos);
                // Arimaa traps: only C3, F3, C6, F6 should be dark.
                // With 0-based indices, columns A..H -> 0..7, rows top(8)..bottom(1) -> 0..7
                // So C3 -> (row 5, col 2), F3 -> (5,5), C6 -> (2,2), F6 -> (2,5)
                var isDark = (r == 2 || r == 5) && (c == 2 || c == 5);
                var isSelected = _selectedPos == pos;
                <div class="square @(isDark ? "dark" : "light") @(isSelected ? "selected" : "")"
                     @onpointerup="() => OnPointerUp(pos)">
                    @if (piece is not null)
                    {
                        <img src="@($"pieces/{piece.SvgFileName}")"
                             alt="@($"{piece.Side} {piece.Type}")"
                             draggable="false"
                             title="@(Behavior.IsInteractive ? "Drag to move" : "")"
                             @onpointerdown="() => OnDragStart(pos)"
                             />
                }
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter]
    public BoardBehavior Behavior { get; set; } = BoardBehavior.Playable;

    private Position? _selectedPos;

    private void OnDragStart(Position from)
    {
        if (!Behavior.IsInteractive) return;

        // Only start a drag if there's a piece on the square
        if (Game.State.GetPiece(from) is not null)
        {
            _selectedPos = from;
        }
    }

    private void OnPointerUp(Position target)
    {
        if (_selectedPos is { } from)
        {
            // If the source and target are the same, it's a selection (or a drag-release captured by source).
            // We keep the selection so the user can tap the destination next.
            if (from == target)
            {
                return;
            }

            // Attempt the move using the simplified rules
            Game.TryMove(from, target);
        }
        _selectedPos = null;
    }
}
